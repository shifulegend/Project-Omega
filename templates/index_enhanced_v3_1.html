<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Omega Enhanced v3.1.0 - Advanced AI Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(0, 0, 0, 0.2);
            color: white;
            padding: 1rem;
            text-align: center;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
        }

        .header .controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            flex: 1;
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            gap: 1rem;
        }

        .sidebar {
            width: 350px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: calc(100vh - 150px);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            max-height: calc(100vh - 300px);
        }

        .chat-input-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .session-type-switcher {
            display: flex;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.25rem;
            margin-bottom: 1rem;
        }

        .session-type-btn {
            flex: 1;
            background: none;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            color: #666;
        }

        .session-type-btn.active {
            background: #007bff;
            color: white;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .tooltip {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: #007bff;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-size: 12px;
            line-height: 16px;
            cursor: help;
            margin-left: 5px;
            position: relative;
        }

        .tooltip:hover::after {
            content: attr(title);
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            font-size: 12px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .message.user {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.assistant {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
        }

        .message.agent {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
            border-left: 4px solid #ffc107;
        }

        .message.command-result {
            background: #000;
            color: #00ff00;
            font-family: 'Courier New', monospace;
        }

        .message pre {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 0.5rem;
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .message code {
            background: rgba(0, 0, 0, 0.1);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .status-online {
            background: #28a745;
        }

        .status-offline {
            background: #dc3545;
        }

        .status-connecting {
            background: #ffc107;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .feature-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .pill {
            background: #e9ecef;
            color: #495057;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.875rem;
            border: 1px solid #dee2e6;
        }

        .pill.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .agent-mode-help {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .agent-mode-help h4 {
            color: #155724;
            margin-bottom: 0.5rem;
        }

        .agent-mode-help ul {
            margin-left: 1rem;
            color: #155724;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 80%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .close {
            font-size: 2rem;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        .settings-section {
            margin-bottom: 2rem;
        }

        .settings-section h3 {
            color: #333;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .tunnel-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .tunnel-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .tunnel-url {
            color: #007bff;
            text-decoration: none;
            flex: 1;
        }

        .tunnel-url:hover {
            text-decoration: underline;
        }

        .chat-input {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .chat-input textarea {
            flex: 1;
            min-height: 50px;
            max-height: 150px;
            resize: vertical;
        }

        .model-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                order: 2;
            }
            
            .chat-container {
                order: 1;
            }

            .header {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Project Omega Enhanced v3.1.0</h1>
        <div class="controls">
            <div class="feature-pills" id="headerFeatures">
                <span class="pill active">üåê Multi-Tunnel</span>
                <span class="pill active">üß† Self-Learning</span>
                <span class="pill active">üîç Internet</span>
            </div>
            <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <!-- Session Type Switcher -->
            <div class="session-type-switcher">
                <button class="session-type-btn active" data-type="chat" onclick="switchSessionType('chat')">
                    üí¨ Chat
                </button>
                <button class="session-type-btn" data-type="agent" onclick="switchSessionType('agent')">
                    üñ•Ô∏è Agent
                </button>
            </div>

            <!-- Chat Mode Settings -->
            <div id="chatSettings">
                <div class="section-title">ü§ñ AI Model</div>
                <div class="form-group">
                    <label for="modelSelect">Model 
                        <span class="tooltip" title="Choose AI model for conversation">(?)</span>
                    </label>
                    <select id="modelSelect">
                        <option value="">Loading models...</option>
                    </select>
                    <div class="model-info" id="modelInfo">Select a model to see details</div>
                </div>

                <div class="section-title">‚öôÔ∏è AI Settings</div>
                <div class="form-group">
                    <label for="temperature">Temperature 
                        <span class="tooltip" title="Controls creativity. 0.1=focused, 1.0=balanced, 1.5=creative">(?)</span>
                    </label>
                    <input type="range" id="temperature" min="0.1" max="2.0" step="0.1" value="0.7">
                    <span id="temperatureValue">0.7</span>
                </div>
                
                <div class="form-group">
                    <label for="maxTokens">Max Tokens 
                        <span class="tooltip" title="Maximum response length. Higher=longer responses">(?)</span>
                    </label>
                    <input type="range" id="maxTokens" min="256" max="4096" step="256" value="2048">
                    <span id="maxTokensValue">2048</span>
                </div>

                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="thinkingMode">
                        <label for="thinkingMode">Thinking Mode 
                            <span class="tooltip" title="Shows AI reasoning process for complex problems">(?)</span>
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="internetAccess" checked>
                        <label for="internetAccess">Internet Access 
                            <span class="tooltip" title="AI can search web for current information">(?)</span>
                        </label>
                    </div>
                    
                    <div class="checkbox-group">
                        <input type="checkbox" id="learningMode" checked>
                        <label for="learningMode">Learning Mode 
                            <span class="tooltip" title="AI learns from corrections to improve responses">(?)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="systemPrompt">System Prompt 
                        <span class="tooltip" title="Instructions for AI behavior">(?)</span>
                    </label>
                    <textarea id="systemPrompt" rows="3" placeholder="You are a helpful AI assistant..."></textarea>
                </div>
            </div>

            <!-- Agent Mode Settings -->
            <div id="agentSettings" class="hidden">
                <div class="agent-mode-help">
                    <h4>üñ•Ô∏è Natural Language Agent</h4>
                    <p>Ask me to do things in plain English:</p>
                    <ul>
                        <li>"What is the Python version?"</li>
                        <li>"List all files here"</li>
                        <li>"Show disk space"</li>
                        <li>"Install pip package requests"</li>
                        <li>"Create directory called 'test'"</li>
                    </ul>
                    <p><small>I'll interpret your request and run the appropriate command.</small></p>
                </div>
                
                <div class="form-group">
                    <label for="agentSystemPrompt">Agent Instructions 
                        <span class="tooltip" title="Special instructions for agent behavior">(?)</span>
                    </label>
                    <textarea id="agentSystemPrompt" rows="2" placeholder="You are a system administrator agent..."></textarea>
                </div>
            </div>

            <!-- Session Management -->
            <div class="section-title">üíæ Session</div>
            <div class="form-group">
                <label for="sessionName">Session Name</label>
                <input type="text" id="sessionName" placeholder="My Chat Session" value="Default Session">
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary" onclick="createNewSession()">‚ûï New Session</button>
                <button class="btn btn-secondary" onclick="clearMessages()">üóëÔ∏è Clear Chat</button>
                <a href="/learning_logs" class="btn btn-success" target="_blank">üìö Learning Logs</a>
            </div>
        </div>

        <div class="chat-container">
            <div class="chat-header">
                <div>
                    <span class="status-indicator status-connecting" id="connectionStatus"></span>
                    <span id="sessionTitle">Project Omega Enhanced v3.1.0</span>
                </div>
                <div class="feature-pills" id="activeFeatures">
                    <span class="pill">üí¨ Chat Mode</span>
                </div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <strong>üöÄ Project Omega Enhanced v3.1.0</strong><br><br>
                    Welcome! Choose your mode:
                    <br><br>
                    <strong>üí¨ Chat Mode:</strong><br>
                    ‚Ä¢ Conversation with AI models<br>
                    ‚Ä¢ Internet search integration<br>
                    ‚Ä¢ Self-learning from feedback<br>
                    ‚Ä¢ Custom system prompts<br>
                    <br>
                    <strong>üñ•Ô∏è Agent Mode:</strong><br>
                    ‚Ä¢ Natural language commands<br>
                    ‚Ä¢ "What is the Python version?" ‚Üí <code>python --version</code><br>
                    ‚Ä¢ "List files" ‚Üí <code>ls -la</code><br>
                    ‚Ä¢ "Show disk space" ‚Üí <code>df -h</code><br>
                    <br>
                    Switch modes using the tabs above! üéØ
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="chat-input">
                    <textarea id="messageInput" placeholder="Type your message here..." 
                              onkeypress="handleKeyPress(event)"></textarea>
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Settings</h3>
                <span class="close" onclick="closeSettings()">&times;</span>
            </div>
            
            <div class="settings-section">
                <h3>üåê Tunnel URLs</h3>
                <div id="tunnelsList" class="tunnel-list">
                    <div class="tunnel-item">
                        <span class="status-indicator status-connecting"></span>
                        <span>Loading tunnels...</span>
                    </div>
                </div>
                <br>
                <button class="btn btn-secondary" onclick="refreshTunnels()">üîÑ Refresh Tunnels</button>
            </div>

            <div class="settings-section">
                <h3>ü§ñ Model Management</h3>
                <p>Available models are loaded dynamically from Ollama API.</p>
                <button class="btn btn-secondary" onclick="refreshModels()">üîÑ Refresh Models</button>
            </div>

            <div class="settings-section">
                <h3>üß† Learning System</h3>
                <p>AI learns from your feedback to improve responses over time.</p>
                <a href="/learning_logs" class="btn btn-success" target="_blank">üìä View Learning Logs</a>
                <button class="btn btn-danger" onclick="clearLearnings()">üóëÔ∏è Clear All Learnings</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let socket;
        let currentSessionId = generateSessionId();
        let currentSessionType = 'chat';
        let isConnected = false;
        let availableModels = [];
        let lastAIResponse = '';
        let lastUserMessage = '';

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeWebSocket();
            loadModels();
            refreshTunnels();
            setupEventListeners();
        });

        function generateSessionId() {
            return `session_${currentSessionType}_${Math.random().toString(36).substr(2, 9)}_${Date.now()}`;
        }

        function setupEventListeners() {
            document.getElementById('temperature').addEventListener('input', function() {
                document.getElementById('temperatureValue').textContent = this.value;
            });
            
            document.getElementById('maxTokens').addEventListener('input', function() {
                document.getElementById('maxTokensValue').textContent = this.value;
            });

            document.getElementById('modelSelect').addEventListener('change', updateModelInfo);
        }

        function initializeWebSocket() {
            try {
                socket = io();
                
                socket.on('connect', function() {
                    isConnected = true;
                    updateConnectionStatus('online', 'Connected');
                });
                
                socket.on('disconnect', function() {
                    isConnected = false;
                    updateConnectionStatus('offline', 'Disconnected');
                });
                
                socket.on('message_response', function(data) {
                    displayMessage('assistant', data.response, data);
                    lastAIResponse = data.response;
                });
                
                socket.on('error', function(data) {
                    displayMessage('assistant', `‚ùå Error: ${data.message}`, { isError: true });
                });
                
                socket.on('tunnel_update', function(data) {
                    refreshTunnels();
                });
                
            } catch (error) {
                console.error('WebSocket error:', error);
                updateConnectionStatus('offline', 'Connection failed');
            }
        }

        function updateConnectionStatus(status, message) {
            const indicator = document.getElementById('connectionStatus');
            const title = document.getElementById('sessionTitle');
            
            indicator.className = `status-indicator status-${status}`;
            title.textContent = message;
        }

        function loadModels() {
            fetch('/api/models')
                .then(response => response.json())
                .then(models => {
                    availableModels = models;
                    populateModelSelect(models);
                })
                .catch(error => {
                    console.error('Error loading models:', error);
                    // Fallback to basic model
                    const fallbackModels = [{
                        id: 'mistral:7b-instruct',
                        name: 'Mistral 7B Instruct',
                        description: 'Fallback model',
                        size_gb: 0
                    }];
                    availableModels = fallbackModels;
                    populateModelSelect(fallbackModels);
                });
        }

        function populateModelSelect(models) {
            const select = document.getElementById('modelSelect');
            select.innerHTML = '';
            
            models.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.name} (${model.size_gb}GB)`;
                option.dataset.description = model.description;
                option.dataset.thinking = model.supports_thinking || false;
                option.dataset.internet = model.supports_internet || true;
                select.appendChild(option);
            });
            
            if (models.length > 0) {
                select.selectedIndex = 0;
                updateModelInfo();
            }
        }

        function updateModelInfo() {
            const select = document.getElementById('modelSelect');
            const info = document.getElementById('modelInfo');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption) {
                info.textContent = selectedOption.dataset.description || 'AI model for conversation';
                
                // Update thinking mode availability
                const supportsThinking = selectedOption.dataset.thinking === 'true';
                document.getElementById('thinkingMode').disabled = !supportsThinking;
                if (!supportsThinking) document.getElementById('thinkingMode').checked = false;
            }
        }

        function switchSessionType(type) {
            currentSessionType = type;
            currentSessionId = generateSessionId();
            
            // Update UI
            document.querySelectorAll('.session-type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');
            
            // Show/hide appropriate settings
            if (type === 'chat') {
                document.getElementById('chatSettings').classList.remove('hidden');
                document.getElementById('agentSettings').classList.add('hidden');
                document.getElementById('messageInput').placeholder = 'Type your message here...';
                updateActiveFeatures(['üí¨ Chat', 'üß† Learning', 'üåê Internet']);
            } else {
                document.getElementById('chatSettings').classList.add('hidden');
                document.getElementById('agentSettings').classList.remove('hidden');
                document.getElementById('messageInput').placeholder = 'Ask me to do something: "What is the Python version?"';
                updateActiveFeatures(['üñ•Ô∏è Agent', 'üîç Commands']);
            }
            
            // Clear messages for new session type
            clearMessages();
            
            // Show appropriate welcome message
            if (type === 'agent') {
                displayMessage('assistant', `üñ•Ô∏è **Agent Mode Activated**

I can understand natural language and execute commands for you.

**Try asking me:**
‚Ä¢ "What is the Python version?"
‚Ä¢ "List all files in current directory"
‚Ä¢ "Show me the disk space"
‚Ä¢ "Check running processes"
‚Ä¢ "Install pip package requests"

I'll interpret your request and run the appropriate command! üöÄ`, { session_type: 'agent' });
            } else {
                displayMessage('assistant', `üí¨ **Chat Mode Activated**

I'm ready for conversation! I can:
‚Ä¢ Answer questions with internet search
‚Ä¢ Learn from your feedback
‚Ä¢ Use custom system prompts
‚Ä¢ Adjust my creativity and response length

What would you like to talk about? ü§ñ`, { session_type: 'chat' });
            }
        }

        function updateActiveFeatures(features) {
            const container = document.getElementById('activeFeatures');
            container.innerHTML = '';
            
            features.forEach(feature => {
                const pill = document.createElement('span');
                pill.className = 'pill active';
                pill.textContent = feature;
                container.appendChild(pill);
            });
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !isConnected) return;
            
            lastUserMessage = message;
            displayMessage('user', message);
            
            const data = {
                session_id: currentSessionId,
                session_type: currentSessionType,
                message: message,
                model: document.getElementById('modelSelect').value,
                temperature: parseFloat(document.getElementById('temperature').value),
                max_tokens: parseInt(document.getElementById('maxTokens').value),
                thinking_mode: document.getElementById('thinkingMode').checked,
                internet_access: document.getElementById('internetAccess').checked,
                system_prompt: currentSessionType === 'chat' ? 
                    document.getElementById('systemPrompt').value : 
                    document.getElementById('agentSystemPrompt').value
            };
            
            socket.emit('send_message', data);
            messageInput.value = '';
        }

        function displayMessage(role, content, metadata = {}) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            
            let messageClass = `message ${role}`;
            if (metadata.session_type === 'agent') messageClass += ' agent';
            if (metadata.is_command_result) messageClass += ' command-result';
            
            messageDiv.className = messageClass;
            
            // Format content
            let formattedContent = content
                .replace(/```([\s\S]*?)```/g, '<pre>$1</pre>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
            
            // Add metadata for responses
            if (role === 'assistant' && !metadata.isError) {
                let badges = '';
                if (metadata.internet_used) badges += '<span class="pill active">üåê Internet</span> ';
                if (metadata.learnings_applied > 0) badges += `<span class="pill active">üß† ${metadata.learnings_applied} Learnings</span> `;
                if (metadata.interpretation) badges += `<span class="pill active">üéØ ${metadata.interpretation}</span> `;
                
                if (badges) {
                    formattedContent = `<div style="margin-bottom: 0.5rem;">${badges}</div>${formattedContent}`;
                }
            }
            
            messageDiv.innerHTML = formattedContent;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function createNewSession() {
            currentSessionId = generateSessionId();
            clearMessages();
            displayMessage('assistant', 'üÜï New session created! Ready for conversation.', {});
        }

        function clearMessages() {
            document.getElementById('chatMessages').innerHTML = '';
        }

        function refreshModels() {
            loadModels();
        }

        function refreshTunnels() {
            fetch('/api/tunnels')
                .then(response => response.json())
                .then(tunnels => {
                    const container = document.getElementById('tunnelsList');
                    container.innerHTML = '';
                    
                    if (Object.keys(tunnels).length === 0) {
                        container.innerHTML = `
                            <div class="tunnel-item">
                                <span class="status-indicator status-connecting"></span>
                                <span>Starting tunnels...</span>
                            </div>
                        `;
                        return;
                    }
                    
                    Object.entries(tunnels).forEach(([provider, url]) => {
                        const item = document.createElement('div');
                        item.className = 'tunnel-item';
                        item.innerHTML = `
                            <span class="status-indicator status-online"></span>
                            <a href="${url}" target="_blank" class="tunnel-url">${provider}: ${url}</a>
                            <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="copyToClipboard('${url}')">üìã</button>
                        `;
                        container.appendChild(item);
                    });
                })
                .catch(error => {
                    console.error('Error fetching tunnels:', error);
                });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                event.target.textContent = '‚úÖ';
                setTimeout(() => {
                    event.target.textContent = 'üìã';
                }, 1000);
            });
        }

        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
            refreshTunnels();
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function clearLearnings() {
            if (confirm('This will clear all AI learnings. Are you sure?')) {
                // Implementation for clearing learnings
                alert('Learnings cleared! (Feature in development)');
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('settingsModal');
            if (event.target === modal) {
                closeSettings();
            }
        }
    </script>
</body>
</html>